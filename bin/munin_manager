#!/usr/bin/env ruby

require 'rubygems'
require 'ruby-debug'

require 'optparse'
require 'ostruct'
require "#{File.dirname(__FILE__)}/../lib/munin_manager"

options = OpenStruct.new
options.plugin_dir = "/etc/munin/plugins"

parser = OptionParser.new do |opts|
  opts.banner = "Usage: munin_manager <command> [<plugin_name>[:<symlink_name>]] [options]"
  opts.separator ""
  
  opts.separator "Commands:"
  
  opts.on("-l", "--list", "List available plugins to install") do
    buffer = []
    buffer << "Available Plugins"
    buffer << "================="
    buffer << ""
    
    MuninManager::Plugins.each do |plugin|
      buffer << plugin.plugin_name
    end
    
    buffer << ""
    puts buffer.join("\n")
  end
  
  opts.on("-s", "--show PLUGIN_NAME", "Shows details about a plugin") do |name|
    begin
      puts MuninManager::Plugins[name].help_text
    rescue NoMethodError
      STDERR.puts "'%s' plugin was not found" % name
    rescue
      STDERR.puts "No additional information is available about this plugin."
    end
  end
  
  opts.on("--plugin-dir DIR", "Directory where symlinks will be created when a plugin is installed",
         "(default is '%s'" % options.plugin_dir) do |dir|
    if File.directory?(dir) && File.writable?(dir)
      options.plugin_dir = dir
    else
      STDERR.puts "'%s' does not exist or is not writable" % options.plugin_dir
    end
  end
  
  opts.on("-a", "--install", "Installs a plugin by creating a symlink in '%s'" % options.plugin_dir)
  
  opts.on("-u", "--uninstall PLUGIN_NAME [PLUGIN_NAME]", Array,
    "Removes plugins from '%s'" % options.plugin_dir,
    "if it is a symlink") do |names|
    
    if options.plugins = MuninManager::Plugins[*names]
      options.action = :uninstall      
      options.plugin_names = names
    else
      puts "'#{names}' plugin not found"
    end
  end
  
end

parser.parse!(ARGV)
options.freeze!

case options.action
when :uninstall, :install
  plugins = Array(MuninManager::Plugins[*options.plugin_names])
  plugins.each {|p| p.send(options.action, options)}
end
